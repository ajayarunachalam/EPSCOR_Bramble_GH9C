---
- hosts: Danforth_Shakoor
  gather_facts: False
  remote_user: pi
  become: yes
  vars:
    utmp: true
    use_dns: true
    restart_ganglia: false
    restart_ssh: false
    
  tasks:
    - name: Restart ganglia on all PIs.
      command: systemctl restart ganglia-monitor
      when: restart_ganglia

    - name: Restart ssh service on all PIs
      command: systemctl restart ssh.service
      when: restart_ssh
      
    - name: Find with grep if -u0 exists
      command: grep '-u0' /etc/default/ssh
      register: utmp_set
      failed_when: False
      
    - name: Set no utmp in sshd. No DNS reverse lookup.
      command: sed -i 's/\(SSHD_OPTS=\).*/\1-u0/' /etc/default/ssh
      when: (utmp and utmp_set.rc == 1)

    - name: Set utmp back in sshd.
      command: sed -i 's/\(SSHD_OPTS=\).*/\1/' /etc/default/ssh
      when: (not utmp and utmp_set.rc == 0)

    - name: Find with awk if UseDNS exists.
      command: grep 'UseDNS'/etc/ssh/sshd_config
      register: dns_exist
      failed_when: False

    - name: Add UseDNS no to sshd_config
      # command: echo "UseDNS no" >> /etc/ssh/sshd_config
      command: sed -i -e '$aUseDNS no' /etc/ssh/sshd_config
      when: (use_dns and dns_exist.rc == 1)

    - name: Remove useDNS from sshd_config.
      shell: sed  '$(grep -n "UseDNS" /etc/ssh/sshd_config | cut -f1 -d':')d' /etc/ssh/sshd_config
      when: (not use_dns and dns_exist.rc == 0)
      
      
      
      
